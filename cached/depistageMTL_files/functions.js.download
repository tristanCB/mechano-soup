(function ($, window, document, undefined) {
    var $win = $(window);
    var $doc = $(document);

    function changeFontSize() {
        $('body').toggleClass('fontsize-large');
    }

    function getFontSize() {
        return ($('body').hasClass('fontsize-large')) ? 'fontsize-large' : getPreferredFontSize();
    }

    function getPreferredFontSize() {
        return 'fontsize-normal';
    }

    function createCookie(name, value, days) {
        var expires = new Date;
        if (days < 1) {
            days = 1;
        }
        expires.setDate(expires.getDate() + days);
        var expiresString = "; expires=" + expires;
        document.cookie = name + "=" + value + expiresString + "; path=/";
    }

    function readCookie(name) {
        var nameEQ = name + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) === ' ') {
                c = c.substring(1, c.length);
            }
            if (c.indexOf(nameEQ) === 0) {
                return c.substring(nameEQ.length, c.length);
            }
        }
        return null;
    }

    function manageFontSize() {
        //Pour la taille du texte -----------------------------------------------------------------------------------
        var cookie = readCookie("fontsize");
        var title = cookie ? cookie : getPreferredFontSize();

        if (title === 'fontsize-large') {
            changeFontSize();
        }
        $("a.sizetext").click(function (e) {
            e.preventDefault();
            changeFontSize();
        });
    }


    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition);
        }
    }

    function showPosition(position) {
        $('#currentLocationHidden').val(position.coords.latitude + ',' + position.coords.longitude);
        if(typeof map !== 'undefined'){
            map.setCenter(new google.maps.LatLng(position.coords.latitude, position.coords.longitude), 13);
        }
        $('#currentLocation').attr('placeholder',"Votre localisation actuelle");
    }

    function loadMoreLikeThis() {

        if ($('#moreLikeThis').length) {
                        pageCurrentUrl = pageCurrentUrl.replace(/^.*\/\/[^\/]+/, '')

		var $moreLkeThis = $('#moreLikeThis'),
                    typeNum = $moreLkeThis.data('typeNum'),
                    $keywords = $('meta[name="keywords"]'),
                    $pageTitle = $('title'),
                    urlBase = pageHomeUrl,
                    urlCurrent = pageCurrentUrl;

            urlBase += '?';
            urlBase += '&type=' + typeNum;
            urlBase += '&urlCurrent=' + encodeURIComponent(urlCurrent);
            var url = urlBase;

            if ($.trim($keywords.attr('content')).length) {
                url += '&q=' + encodeURIComponent($keywords.attr('content'));

                $moreLkeThis.toggleClass('ajax-loading');
                $.post(url, function (data) {
                    $moreLkeThis.html(data);
                    if( $moreLkeThis.find('.tx-solr').length && !$.trim($moreLkeThis.find('.tx-solr').html()).length ) {
                        url = urlBase;
                        url += '&q=' + encodeURIComponent($pageTitle.text());

                        $moreLkeThis.toggleClass('ajax-loading');
                        $.post(url, function (data) {
                            $moreLkeThis.html(data);
                        }).always(function () {
                            $moreLkeThis.toggleClass('ajax-loading');
                        });
                    }
                }).always(function () {
                    $moreLkeThis.toggleClass('ajax-loading');
                });
            } else {
                url += '&q=' + encodeURIComponent($pageTitle.text());

                $moreLkeThis.toggleClass('ajax-loading');
                $.post(url, function (data) {
                    $moreLkeThis.html(data);
                }).always(function () {
                    $moreLkeThis.toggleClass('ajax-loading');
                });
            }
        }
    }

    /* cachedScript (http://api.jquery.com/jQuery.getScript/)*/
    $.cachedScript = function (url, options) {

        // Allow user to set any option except for dataType, cache, and url
        options = $.extend(options || {}, {
            dataType: "script",
            cache: true,
            url: url
        });

        // Use $.ajax() since it is more flexible than $.getScript
        // Return the jqXHR object so we can chain callbacks
        return $.ajax(options);
    };

    $win.unload(function () {
        //Pour la taille du texte -----------------------------------------------------------------------------------
        createCookie("fontsize", getFontSize(), 365);
    });

    $doc.ready(function () {
        manageFontSize();

        var urlVars = getUrlVars();
        if(urlVars["sectionField"]) {
            $("#tx-solr-search-functions ul.facet-option-list").append('<li class="facet-option active hidden" style="margin: 0; padding: 0;"><div class="checkbox hidden"><input type="checkbox" name="tx_solr[filter][]" value="section_stringS:'+urlVars["sectionField"]+'" checked="checked"></div></li>');
        }
        // Menu principal dynamique
        $('.main-navigation .nav-dropdown .nav-col.sous-liste').each(function () {
           // if(!$('html').hasClass('lt-ie9')) {
                var items = $(this).find("li"),
                        items_per_col = new Array(),
                        nbCols = 1;
                if (items.length < 2) {
                }
                else if (items.length < 5) {
                    nbCols = 2;
                }
                else {
                    nbCols = 3;
                }

                if (nbCols > 1) {
                    var min_items_per_col = Math.floor(items.length / nbCols),
                            difference = items.length - (min_items_per_col * nbCols);

                    for (var i = 0; i < nbCols; i++) {
                        if (i < difference) {
                            items_per_col[i] = min_items_per_col + 1;
                        } else {
                            items_per_col[i] = min_items_per_col;
                        }
                    }
                    var itemsHtml = [];
                    items.each(function () {
                        itemsHtml.push($(this).html());
                    });
                    for (var i = 0; i < nbCols; i++) {
                        if (i === 0) {
                            $(this).html('<ul></ul>');
                        }
                        else {
                            $(this).parent().append('<div class="nav-col sous-liste"><ul></ul></div>');
                        }
                        for (var j = 0; j < items_per_col[i]; j++) {
                            var pointer = 0;
                            for (var k = 0; k < i; k++) {
                                pointer += items_per_col[k];
                            }
                            $(this).parent().find('.sous-liste').last().find('ul').append('<li>' + itemsHtml[j + pointer] + '</li>');
                        }
                    }
                }
           // }
        });

        // Back To Top
        $('.back-to-top').on('click', function (e) {
            e.preventDefault();

            $('html, body').animate({scrollTop: 0}, 700);
        });
        $('#field-ressourcetype').on('change', function (e) {
            $('.form-col .search-ressourcetype  .form-btn').click();
         });
        // Tabs
        var activeTabClass = 'current';

        $('.tabs-nav a').on('click', function (event) {
            event.preventDefault();

            var $tabLink = $(this),
                    $targetLink = $tabLink.attr('href').match(new RegExp('#([^&]*)'))[1],
                    $targetTab = $('#' + $targetLink);

            $tabLink
                    .parent() // go up to the <li> element
                    .add($targetTab)
                    .addClass(activeTabClass)
                    .siblings()
                    .removeClass(activeTabClass);
        });



        // Widget Navigation

        $(".widget-navigation li > a > .dropdownSpan").on("click", function (e) {
            var animationTime = 1000;
            var menu = $(this).parent().parent();

            if (!menu.hasClass("animation")) {
                if (menu.children(".dropdown").is(":hidden")) {
                    menu.addClass("active animation");
                    menu.children(".dropdown").slideDown(animationTime, function () {
                        menu.removeClass("animation");
                    });
                    menu.siblings().children(".dropdown").slideUp(animationTime, function () {
                        menu.siblings().removeClass("active");
                    });
                } else {
                    menu.removeClass("active");
                    menu.addClass("animation");
                    menu.children(".dropdown").slideUp(animationTime, function () {
                        menu.removeClass("animation");
                    });
                }
            }
            e.preventDefault();
        });

        // List Dates Dropdown
       $('.list-dates > li > a').on('click', function (e) {
            var $this = $(this);
            var $next = $this.next();

            if ($next.hasClass('dropdown')) {
                e.preventDefault();

                $next.slideToggle().parent().toggleClass('current')
                        .siblings().removeClass('current')
                        .find('.nav-dropdown').stop(true, true).slideUp(500);
                $next.slideToggle().parent().find('.sub-navdropdown').stop(true, true).slideUp(500);
            }
        });

        // Mobile navigation
        $('.nav-btn').on('click', function (e) {
            e.preventDefault();

            $(this).toggleClass('active');

            $('.main-navigation').stop(true, true).slideToggle(200);
        });

        if ($win.width() > 767) {
            $('.main-navigation').addClass('visible');
        } else {
            $('.main-navigation').removeClass('visible');
        }
        ;

        $win.resize(function () {
            if ($win.width() > 767) {
                $('.main-navigation').addClass('visible');
            } else {
                $('.main-navigation').removeClass('visible');
            }
            ;
        });

        if ($win.width() > 640) {
            $('.section-aside-filters').addClass('visible');
        } else {
            $('.section-aside-filters').removeClass('visible');
        }
        ;

        $win.resize(function () {
            if ($win.width() > 640) {
                $('.section-aside-filters').addClass('visible');
            } else {
                $('.section-aside-filters').removeClass('visible');
            }
            ;
        });
        // Navigation dropdown
        $('.nav').on('mouseleave', function () {
            var $this = $(this);
            if ($win.width() > 768 && $('body').attr("data-state")!="keyboard") {
                $('.nav > ul > li').siblings().find('.sub-navdropdown').stop(true, true);
                $('.nav > ul > li').removeClass('current').find('.nav-dropdown').stop(true, true).slideUp(500);
                $('.nav > ul > li').find('.sub-navdropdown').stop(true, true).hide();
            }
        });

        // Navigation dropdown
        $('.nav > ul > li > a').on('mouseenter focusin', function () {
            var $this = $(this);

            if ($win.width() > 768) {
                $('.nav > ul > li').siblings().find('.sub-navdropdown').stop(true, true);
                $('.nav > ul > li').removeClass('current').find('.nav-dropdown').stop(true, true).hide();
                $('.nav > ul > li').find('.sub-navdropdown').stop(true, true).hide();
                $this.parent().find('.nav-dropdown').stop(true, true).show();
                $this.parent().addClass('current').find('.sub-navdropdown').stop(true, true).slideDown(500);
            }
        });
        $('.nav > ul > li .sub-navdropdown .nav-col:last-of-type li:last-child a').on('focusout', function (){
            $('.nav > ul > li').removeClass('current').find('.nav-dropdown').stop(true, true).hide();
        });

        $('.nav').on('click', 'a', function (e) {
            var $this = $(this);
            var $next = $this.next();

            if ($win.width() < 769 && $next.hasClass('nav-dropdown')) {
                e.preventDefault();

                $next.slideToggle().parent().toggleClass('current')
                        .siblings().removeClass('current')
                        .find('.nav-dropdown').stop(true, true).slideUp(500);
                $next.find('.sub-navdropdown').slideDown().parent().siblings().find('.sub-navdropdown').stop(true, true).slideUp(500);
            }
        });

        /*recherche*/
        // le nombre de résultats devant les filtres et tris
        if (($('#tx-solr-faceting-result').length > 0) && ($('#resultnumber').length > 0)) {
            //$('#resultnumber').before($('#tx-solr-faceting-result'));
            $('#tx-solr-faceting-result').before($('#resultnumber'));
        }

        $('.tx-solr-facet-show-all').click(function (e) {
            e.preventDefault();
            if ($('.tx-solr-facet-hidden:visible').length == 0) {
                $(this).parent().siblings('.tx-solr-facet-hidden').show();
                $(this).text($(this).data('label-less'));
            } else {
                $(this).parent().siblings('.tx-solr-facet-hidden').hide();
                $(this).text($(this).data('label-more'));
            }
            $(this).parents('.filters-body-row').find('.show-all-box').toggle();
        });
        $('.show-all-box-close').click(function(e) {
            e.preventDefault();
            if ($('.tx-solr-facet-hidden:visible').length == 0) {
                $(this).parent().siblings('.tx-solr-facet-hidden').show();
                $('.tx-solr-facet-show-all').text($('.tx-solr-facet-show-all').data('label-less'));
            } else {
                $(this).parent().siblings('.tx-solr-facet-hidden').hide();
                $('.tx-solr-facet-show-all').text($('.tx-solr-facet-show-all').data('label-more'));
            }
            $(this).parents('.show-all-box').hide();
        });

        $('.show-all-box-actions .facets-control.reset').click(function(e){
            e.preventDefault();
            $('.show-all-box-actions .facets-control.reset').parents('.show-all-box').find('input:checkbox').prop('checked', false);
        });

        $('.tx-solr .filters-primary.mobile-only').html($('.tx-solr .filters-primary.mobile-hide').html());

        $("ul.facet-option-list li.tx-solr-facet-hidden").each(function () {
            $(this).parents('.filters-body-row').find('.show-all-box ul.more-facet').append($(this));
            //$(this).removeClass('tx-solr-facet-hidden');
            $(this).show();
        });

        $('.btnsearch').click(function () {
            /*Code pour éviter de re-post les facets checkbox en double*/
            $('.hiddenFilter input').not('[name="tx_solr[location]"]').each(function () {
                tmp = $(this).val().split('%3A');
                tmp = tmp[0];
                if ($('.cb' + tmp).length > 0) {
                    $(this).remove();
                }

            });
            //console.log($('.$() input'));
            $('.formFilter').submit();
        });
        //localisation

        if ($('#currentLocation').length) {
            $('#currentLocation').click(function () {
                if ($('#currentLocationHidden').val() == '') {
                    getLocation();
                }
            });
            if ($('#currentLocationHidden').val() !== '') {
                var latLngArray = $('#currentLocationHidden').val().split(',');
                if (latLngArray.length === 2) {
                    var lat = latLngArray[0],
                        lng = latLngArray[1];
                    if (typeof map !== 'undefined'){
                        map.setCenter(new google.maps.LatLng(lat, lng), 13);
                    }
                }
            }

           /* var mapOpt = {map: '#map'}*/
            $('#currentLocation').geocomplete()
                    .bind("geocode:result", function (event, result) {
                        $("#currentLocationHidden").val(result.geometry.location.lat()+","+result.geometry.location.lng());
                        if(typeof map !== 'undefined'){
                            map.setCenter(new google.maps.LatLng(result.geometry.location.lat(), result.geometry.location.lng()), 13);
                        }
                    })
                    .bind("geocode:error", function (event, status) {

                    })
                    .bind("geocode:multiple", function (event, results) {

                    });

            $("#find").click(function () {
                $("#currentLocation").trigger("geocode");
            });

        }

        /* fichethematique-single */
        if ($('#fichethematique-single').length) {
            //Check if elements are empty
            $('#fichethematique-single .update-body .update-entry').each(function() {
                var $this = $(this);
                if( !$.trim($this.find('.update-entry-body').html()).length ) {
                    $this.addClass('hidden');
                    $('#link-'+$this.attr('id')).parent('li').addClass('hidden');
                }
            });
            //Reorder menu
            if($('#fichethematique-single .update-outro .list-arrows-secondary li:not(.hidden)').length != $('#fichethematique-single .update-outro .list-arrows-secondary li').length) {
                var i = 0,
                        tempUl = '',
                        tempUlLi = '';
                $('#fichethematique-single .update-outro .list-arrows-secondary li:not(.hidden)').each(function() {
                    tempUlLi += '<li>\n\
'
                            + $(this).html()
                    + '\n\
</li>';
                    i++;
                    if(i % 3 === 0) {
                        tempUl += '\
<ul class="list-arrows list-arrows-secondary">'
                            + tempUlLi
                            + '</ul>\n\
<!-- /.list-arrows -->';
                        tempUlLi = '';
                    } else if(i === $('#fichethematique-single .update-outro .list-arrows-secondary li:not(.hidden)').length) {
                        tempUl += '\
<ul class="list-arrows list-arrows-secondary">'
                            + tempUlLi
                            + '</ul>\n\
<!-- /.list-arrows -->';
                    }
                });

                $('#fichethematique-single .update-outro ul.list-arrows.list-arrows-secondary').remove();
                $('#fichethematique-single .update-outro').append(tempUl);
            }
            //Click on menu
            $('#fichethematique-single .update-outro a').on('click', function () {
                var $link = $(this),
                        $targetLink = $link.attr('href').match(new RegExp('#([^&]*)'))[1],
                        $targetEntry = $('#' + $targetLink);
                $targetEntry.removeClass('close');
            });
            //Click on title
            $('#fichethematique-single .update-body .update-entry .update-entry-title').on('click', function () {
                var $this = $(this),
                $entry = $this.parent('.update-entry');
                $entry.toggleClass('close');
                $entry.hasClass('close') ? $this.attr('aria-describedby','close') : $this.attr('aria-describedby','open');
                $entry.hasClass('close') ? $this.attr('aria-expanded',"false") : $this.attr('aria-expanded',"true");
            });
        }


    });

    loadMoreLikeThis();
})(jQuery, window, document);

$(function () {
    // Filters Trigger
    $('.filters-trigger').on('click', function (e) {
        e.preventDefault();

        $(this).toggleClass('active').parents('.section-updates').find('.section-aside').slideToggle(200);
    });

    // Slider
    if ($(".slider .slides").length) {
        $(".slider .slides").carouFredSel({
            auto: false,
            circular:false,
            responsive: true,
            height: 'variable',
            pagination: {
                container: '.slider-paging'
            },
            items: {
                height: 'variable'
            }
        });
    }
});

function getUrlVars() {
    var vars = [], hash;
    var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
    for(var i = 0; i < hashes.length; i++)
    {
        hash = hashes[i].split('=');
        vars.push(hash[0]);
        vars[hash[0]] = hash[1];
    }
    return vars;
}




$( document ).ready(function() {

		$.fn.toggleText = function(t1, t2){
		  if (this.text() == t1) this.text(t2);
		  else                   this.text(t1);
		  return this;
		};

        // Accordeon

		$('.deployer').on('click', '.ferme', function(e) {
			e.preventDefault();
			$(this).removeClass('ferme');
			$(this).addClass('ouvert');
			$(this).toggleText('Tout replier', 'Tout déplier');
			$(".panel-collapse").each(function () {
				$(this).addClass('in');
			});
			$(".panel-title").each(function () {
				$(this).addClass('in');
				$(this).find('i').addClass('arrow-up-grey-small');
				$(this).find('i').removeClass('arrow-down-grey-small');
			});
        });

		$('.deployer').on('click', '.ouvert', function(e) {
			e.preventDefault();
			$(this).removeClass('ouvert');
			$(this).addClass('ferme');
			$(this).toggleText('Tout replier', 'Tout déployer');
			$(".panel-collapse").each(function () {
				$(this).removeClass('in');
			});
			$(".panel-title").each(function () {
				$(this).removeClass('in');
				$(this).find('i').removeClass('arrow-up-grey-small');
				$(this).find('i').addClass('arrow-down-grey-small');
			});
        });


		$('.panel-title').click(function(e){
			$(this).find('i').toggleClass('arrow-up-grey-small');
			$(this).find('i').toggleClass('arrow-down-grey-small');
		});


        //$('.menu-lecteurdecran').css("font-size","0");
        $(document).on('keydown',function(e){
            $('body').attr('data-state','keyboard');
        });
        var last_position = {},
        mousemove_ok  = true,
        mouse_timer   = setInterval(function () {
            mousemove_ok = true;
        }, 500);
        $(document).on('mousemove', function (event) {
            if (mousemove_ok) {
                mousemove_ok = false;
                if (typeof(last_position.x) != 'undefined') {
                    var deltaX = last_position.x - event.clientX,
                        deltaY = last_position.y - event.clientY;
                    if(deltaX!=0 && deltaY!=0 && $('body').attr('data-state')){
                        $('body').removeAttr('data-state');
                    }
                }
                last_position = {
                    x : event.clientX,
                    y : event.clientY
                };
            }
        });

        $('.menu-lecteurdecran a').focus(function(e){
            $(this).parentsUntil('.menu-lecteurdecran', 'ul, div').removeClass('visually-hidden');
        });

        $('.menu-lecteurdecran a').click(function (e) {
            var href = $(this).attr('href');
            var hrefSplitted = href.split('#');
            var anchorId = hrefSplitted[hrefSplitted.length - 1];
            $('#' + anchorId).attr('tabindex', -1);
            $('#' + anchorId).blur(function (e) {
                $(this).removeAttr('target');
            })
            $('#' + anchorId).focus();
        });

        $('.menu-lecteurdecran a').blur(function(e){
            $(this).parentsUntil('.menu-lecteurdecran', 'ul, div').addClass('visually-hidden');
        });
        $('.slider-paging a').attr('tabindex',-1);

        window.addEventListener("hashchange", function () {
            window.scrollTo(window.scrollX, window.scrollY - 64);
        });

	$('.csc-linkToTop a').click(function(event) {
		document.location.hash = '#'; 
		$(this).attr('href', document.location.href);
	});
});
